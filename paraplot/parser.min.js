if(!Array.indexOf){Array.prototype.indexOf=function(e,t){for(var n=t||0;n<this.length;n++){if(this[n]===e){return n}}return-1}}var Parser=function(e){function t(e){function t(){}t.prototype=e;return new t}function u(e,t,u,a){this.type_=e;this.index_=t||0;this.prio_=u||0;this.number_=a!==undefined&&a!==null?a:0;this.toString=function(){switch(this.type_){case n:return this.number_;case r:case i:case s:return this.index_;case o:return"CALL";default:return"Invalid Token"}}}function a(e,t,n,r){this.tokens=e;this.ops1=t;this.ops2=n;this.functions=r}function h(e){if(typeof e==="string"){l.lastIndex=0;return l.test(e)?"'"+e.replace(l,function(e){var t=c[e];return typeof t==="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+"'":"'"+e+"'"}return e}function p(e,t){return Number(e)+Number(t)}function d(e,t){return e-t}function v(e,t){return e*t}function m(e,t){return e/t}function g(e,t){return e%t}function y(e,t){return""+e+t}function b(e){return-e}function w(e){return Math.random()*(e||1)}function E(e){e=Math.floor(e);var t=e;while(e>1){t=t*--e}return t}function S(e,t){return Math.sqrt(e*e+t*t)}function x(e,t){if(Object.prototype.toString.call(e)!="[object Array]"){return[e,t]}e=e.slice();e.push(t);return e}function T(){this.success=false;this.errormsg="";this.expression="";this.pos=0;this.tokennumber=0;this.tokenprio=0;this.tokenindex=0;this.tmpprio=0;this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,"-":b,exp:Math.exp};this.ops2={"+":p,"-":d,"*":v,"/":m,"%":g,"^":Math.pow,",":x,"||":y};this.functions={random:w,fac:E,min:Math.min,max:Math.max,pyt:S,pow:Math.pow,atan2:Math.atan2};this.consts={E:Math.E,PI:Math.PI}}var n=0;var r=1;var i=2;var s=3;var o=4;var f=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,l=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};a.prototype={simplify:function(e){e=e||{};var o=[];var f=[];var l;var c;var h;var p=this.tokens.length;var d;var v=0;for(v=0;v<p;v++){d=this.tokens[v];var m=d.type_;if(m===n){o.push(d)}else if(m===s&&d.index_ in e){d=new u(n,0,0,e[d.index_]);o.push(d)}else if(m===i&&o.length>1){c=o.pop();l=o.pop();h=this.ops2[d.index_];d=new u(n,0,0,h(l.number_,c.number_));o.push(d)}else if(m===r&&o.length>0){l=o.pop();h=this.ops1[d.index_];d=new u(n,0,0,h(l.number_));o.push(d)}else{while(o.length>0){f.push(o.shift())}f.push(d)}}while(o.length>0){f.push(o.shift())}return new a(f,t(this.ops1),t(this.ops2),t(this.functions))},substitute:function(e,n){if(!(n instanceof a)){n=(new T).parse(String(n))}var r=[];var i=this.tokens.length;var o;var f=0;for(f=0;f<i;f++){o=this.tokens[f];var l=o.type_;if(l===s&&o.index_===e){for(var c=0;c<n.tokens.length;c++){var h=n.tokens[c];var p=new u(h.type_,h.index_,h.prio_,h.number_);r.push(p)}}else{r.push(o)}}var d=new a(r,t(this.ops1),t(this.ops2),t(this.functions));return d},evaluate:function(e){e=e||{};var t=[];var u;var a;var f;var l=this.tokens.length;var c;var h=0;for(h=0;h<l;h++){c=this.tokens[h];var p=c.type_;if(p===n){t.push(c.number_)}else if(p===i){a=t.pop();u=t.pop();f=this.ops2[c.index_];t.push(f(u,a))}else if(p===s){if(c.index_ in e){t.push(e[c.index_])}else if(c.index_ in this.functions){t.push(this.functions[c.index_])}else{throw new Error("undefined variable: "+c.index_)}}else if(p===r){u=t.pop();f=this.ops1[c.index_];t.push(f(u))}else if(p===o){u=t.pop();f=t.pop();if(f.apply&&f.call){if(Object.prototype.toString.call(u)=="[object Array]"){t.push(f.apply(undefined,u))}else{t.push(f.call(undefined,u))}}else{throw new Error(f+" is not a function")}}else{throw new Error("invalid Expression")}}if(t.length>1){throw new Error("invalid Expression (parity)")}return t[0]},toString:function(e){var t=[];var u;var a;var f;var l=this.tokens.length;var c;var p=0;for(p=0;p<l;p++){c=this.tokens[p];var d=c.type_;if(d===n){t.push(h(c.number_))}else if(d===i){a=t.pop();u=t.pop();f=c.index_;if(e&&f=="^"){t.push("Math.pow("+u+","+a+")")}else{t.push("("+u+f+a+")")}}else if(d===s){t.push(c.index_)}else if(d===r){u=t.pop();f=c.index_;if(f==="-"){t.push("("+f+u+")")}else{t.push(f+"("+u+")")}}else if(d===o){u=t.pop();f=t.pop();t.push(f+"("+u+")")}else{throw new Error("invalid Expression")}}if(t.length>1){throw new Error("invalid Expression (parity)")}return t[0]},variables:function(){var e=this.tokens.length;var t=[];for(var n=0;n<e;n++){var r=this.tokens[n];if(r.type_===s&&t.indexOf(r.index_)==-1){t.push(r.index_)}}return t},toJSFunction:function(e,t){var n=new Function(e,"with(Parser.values) { return "+this.simplify(t).toString(true)+"; }");return n}};T.parse=function(e){return(new T).parse(e)};T.evaluate=function(e,t){return T.parse(e).evaluate(t)};T.Expression=a;T.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,random:w,fac:E,exp:Math.exp,min:Math.min,max:Math.max,pyt:S,pow:Math.pow,atan2:Math.atan2,E:Math.E,PI:Math.PI};var N=1<<0;var C=1<<1;var k=1<<2;var L=1<<3;var A=1<<4;var O=1<<5;var M=1<<6;var _=1<<7;var D=1<<8;T.prototype={parse:function(e){this.errormsg="";this.success=true;var f=[];var l=[];this.tmpprio=0;var c=N|L|k|M;var h=0;this.expression=e;this.pos=0;while(this.pos<this.expression.length){if(this.isOperator()){if(this.isSign()&&c&M){if(this.isNegativeSign()){this.tokenprio=2;this.tokenindex="-";h++;this.addfunc(l,f,r)}c=N|L|k|M}else if(this.isComment()){}else{if((c&C)===0){this.error_parsing(this.pos,"unexpected operator")}h+=2;this.addfunc(l,f,i);c=N|L|k|M}}else if(this.isNumber()){if((c&N)===0){this.error_parsing(this.pos,"unexpected number")}var p=new u(n,0,0,this.tokennumber);l.push(p);c=C|A|O}else if(this.isString()){if((c&N)===0){this.error_parsing(this.pos,"unexpected string")}var p=new u(n,0,0,this.tokennumber);l.push(p);c=C|A|O}else if(this.isLeftParenth()){if((c&L)===0){this.error_parsing(this.pos,'unexpected "("')}if(c&_){h+=2;this.tokenprio=-2;this.tokenindex=-1;this.addfunc(l,f,o)}c=N|L|k|M|D}else if(this.isRightParenth()){if(c&D){var p=new u(n,0,0,[]);l.push(p)}else if((c&A)===0){this.error_parsing(this.pos,'unexpected ")"')}c=C|A|O|L|_}else if(this.isComma()){if((c&O)===0){this.error_parsing(this.pos,'unexpected ","')}this.addfunc(l,f,i);h+=2;c=N|L|k|M}else if(this.isConst()){if((c&N)===0){this.error_parsing(this.pos,"unexpected constant")}var d=new u(n,0,0,this.tokennumber);l.push(d);c=C|A|O}else if(this.isOp2()){if((c&k)===0){this.error_parsing(this.pos,"unexpected function")}this.addfunc(l,f,i);h+=2;c=L}else if(this.isOp1()){if((c&k)===0){this.error_parsing(this.pos,"unexpected function")}this.addfunc(l,f,r);h++;c=L}else if(this.isVar()){if((c&N)===0){this.error_parsing(this.pos,"unexpected variable")}var v=new u(s,this.tokenindex,0,0);l.push(v);c=C|A|O|L|_}else if(this.isWhite()){}else{if(this.errormsg===""){this.error_parsing(this.pos,"unknown character")}else{this.error_parsing(this.pos,this.errormsg)}}}if(this.tmpprio<0||this.tmpprio>=10){this.error_parsing(this.pos,'unmatched "()"')}while(f.length>0){var m=f.pop();l.push(m)}if(h+1!==l.length){this.error_parsing(this.pos,"parity")}return new a(l,t(this.ops1),t(this.ops2),t(this.functions))},evaluate:function(e,t){return this.parse(e).evaluate(t)},error_parsing:function(e,t){this.success=false;this.errormsg="parse error [column "+e+"]: "+t;throw new Error(this.errormsg)},addfunc:function(e,t,n){var r=new u(n,this.tokenindex,this.tokenprio+this.tmpprio,0);while(t.length>0){if(r.prio_<=t[t.length-1].prio_){e.push(t.pop())}else{break}}t.push(r)},isNumber:function(){var e=false;var t="";while(this.pos<this.expression.length){var n=this.expression.charCodeAt(this.pos);if(n>=48&&n<=57||n===46){t+=this.expression.charAt(this.pos);this.pos++;this.tokennumber=parseFloat(t);e=true}else{break}}return e},unescape:function(e,t){var n=[];var r=false;for(var i=0;i<e.length;i++){var s=e.charAt(i);if(r){switch(s){case"'":n.push("'");break;case"\\":n.push("\\");break;case"/":n.push("/");break;case"b":n.push("\b");break;case"f":n.push("\f");break;case"n":n.push("\n");break;case"r":n.push("\r");break;case"t":n.push("	");break;case"u":var o=parseInt(e.substring(i+1,i+5),16);n.push(String.fromCharCode(o));i+=4;break;default:throw this.error_parsing(t+i,"Illegal escape sequence: '\\"+s+"'")}r=false}else{if(s=="\\"){r=true}else{n.push(s)}}}return n.join("")},isString:function(){var e=false;var t="";var n=this.pos;if(this.pos<this.expression.length&&this.expression.charAt(this.pos)=="'"){this.pos++;while(this.pos<this.expression.length){var r=this.expression.charAt(this.pos);if(r!="'"||t.slice(-1)=="\\"){t+=this.expression.charAt(this.pos);this.pos++}else{this.pos++;this.tokennumber=this.unescape(t,n);e=true;break}}}return e},isConst:function(){var e;for(var t in this.consts){if(true){var n=t.length;e=this.expression.substr(this.pos,n);if(t===e){this.tokennumber=this.consts[t];this.pos+=n;return true}}}return false},isOperator:function(){var e=this.expression.charCodeAt(this.pos);if(e===43){this.tokenprio=0;this.tokenindex="+"}else if(e===45){this.tokenprio=0;this.tokenindex="-"}else if(e===124){if(this.expression.charCodeAt(this.pos+1)===124){this.pos++;this.tokenprio=0;this.tokenindex="||"}else{return false}}else if(e===42){this.tokenprio=1;this.tokenindex="*"}else if(e===47){this.tokenprio=2;this.tokenindex="/"}else if(e===37){this.tokenprio=2;this.tokenindex="%"}else if(e===94){this.tokenprio=3;this.tokenindex="^"}else{return false}this.pos++;return true},isSign:function(){var e=this.expression.charCodeAt(this.pos-1);if(e===45||e===43){return true}return false},isPositiveSign:function(){var e=this.expression.charCodeAt(this.pos-1);if(e===43){return true}return false},isNegativeSign:function(){var e=this.expression.charCodeAt(this.pos-1);if(e===45){return true}return false},isLeftParenth:function(){var e=this.expression.charCodeAt(this.pos);if(e===40){this.pos++;this.tmpprio+=10;return true}return false},isRightParenth:function(){var e=this.expression.charCodeAt(this.pos);if(e===41){this.pos++;this.tmpprio-=10;return true}return false},isComma:function(){var e=this.expression.charCodeAt(this.pos);if(e===44){this.pos++;this.tokenprio=-1;this.tokenindex=",";return true}return false},isWhite:function(){var e=this.expression.charCodeAt(this.pos);if(e===32||e===9||e===10||e===13){this.pos++;return true}return false},isOp1:function(){var e="";for(var t=this.pos;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()){if(t===this.pos||n!="_"&&(n<"0"||n>"9")){break}}e+=n}if(e.length>0&&e in this.ops1){this.tokenindex=e;this.tokenprio=5;this.pos+=e.length;return true}return false},isOp2:function(){var e="";for(var t=this.pos;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()){if(t===this.pos||n!="_"&&(n<"0"||n>"9")){break}}e+=n}if(e.length>0&&e in this.ops2){this.tokenindex=e;this.tokenprio=5;this.pos+=e.length;return true}return false},isVar:function(){var e="";for(var t=this.pos;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()){if(t===this.pos||n!="_"&&(n<"0"||n>"9")){break}}e+=n}if(e.length>0){this.tokenindex=e;this.tokenprio=4;this.pos+=e.length;return true}return false},isComment:function(){var e=this.expression.charCodeAt(this.pos-1);if(e===47&&this.expression.charCodeAt(this.pos)===42){this.pos=this.expression.indexOf("*/",this.pos)+2;if(this.pos===1){this.pos=this.expression.length}return true}return false}};e.Parser=T;return T}(typeof exports==="undefined"?{}:exports)